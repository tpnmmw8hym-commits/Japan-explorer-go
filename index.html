<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Japan Explorer ‚Äî Muchan_official</title>
<meta name="description" content="Japan Explorer ‚Äî discover Pok√©mon Centers, TeamLab, matcha, mochi workshops, food & activities. Built for Muchan_official." />

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
/* ========== Theme & Layout (Modern, mobile-first) ========== */
:root{
  --bg:#fbfafb;
  --card:#fff;
  --muted:#6b7280;
  --accent:#e60012; /* Japan red */
  --accent-2:#ff5252;
  --success:#10b981;
  --radius:16px;
  --shadow:0 10px 30px rgba(13,38,71,0.08);
  --glass: rgba(255,255,255,0.6);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:#0b1220;-webkit-font-smoothing:antialiased}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--card);box-shadow:var(--shadow);position:sticky;top:0;z-index:999;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{height:46px;width:46px;border-radius:50%;background:linear-gradient(135deg,#fff 0,#ffecec 100%);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);font-size:20px}
.header-title{font-weight:800;font-size:16px}
.tagline{font-size:12px;color:var(--muted)}

/* Map */
#map{height:56vh;width:100%;border-radius:0 0 14px 14px;display:block;}

/* Floating search */
.floating-search{position:fixed;left:50%;transform:translateX(-50%);top:86px;width:88%;max-width:820px;background:var(--card);padding:12px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.08);z-index:1100;display:flex;gap:8px;align-items:center}
.floating-search input{flex:1;padding:12px;border-radius:12px;border:1px solid #eef2f6;font-size:15px}
.floating-search .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700}

/* Panels */
.main-wrap{max-width:1100px;margin:12px auto;padding:12px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;margin-bottom:8px}
.select, .input{padding:12px;border-radius:12px;border:1px solid #eef2f6;background:var(--card);min-width:120px}
.left-col{width:100%;}

/* Place cards */
.places-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px;margin-top:10px}
.place-card{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:flex-start}
.place-card .thumb{width:92px;height:72px;border-radius:8px;background:#f3f4f6;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--muted)}
.place-card h3{margin:0;font-size:16px}
.place-card p{margin:6px 0 0;color:var(--muted);font-size:13px}
.place-card .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}

/* Bottom nav */
.bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:space-around;gap:8px;padding:10px 18px;max-width:760px;margin:0 auto;z-index:1200}
.bottom-nav button{flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800;box-shadow:0 8px 20px rgba(230,0,18,0.12)}

/* Admin / modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:2000;padding:12px}
.modal{width:100%;max-width:980px;background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);max-height:86vh;overflow:auto}
.textarea{width:100%;height:360px;border-radius:10px;border:1px solid #eef2f6;padding:8px;font-family:monospace}

/* utility */
.small{font-size:13px;color:var(--muted)}
.badge{padding:6px 8px;border-radius:999px;background:#fff6f6;color:var(--accent);font-weight:700}

/* responsive */
@media(min-width:900px){
  .places-grid{grid-template-columns:repeat(2,1fr)}
  .floating-search{top:100px}
}
@media(min-width:1200px){
  .places-grid{grid-template-columns:repeat(3,1fr)}
}
.dark{background:#071124;color:#e6f0ff}
.dark header{background:#071727}
.dark .floating-search{background:rgba(4,18,28,0.85);border:1px solid rgba(255,255,255,0.03)}
.dark .place-card{background:#091826;box-shadow:none}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">M</div>
    <div>
      <div class="header-title">Japan Explorer</div>
      <div class="tagline">by Muchan_official ‚Äî Food ‚Ä¢ Pok√©mon ‚Ä¢ Matcha ‚Ä¢ TeamLab</div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button id="manageBtn" class="badge" title="Manage data">Manage Data</button>
    <div style="width:8px"></div>
    <div class="small">@Muchan_official</div>
  </div>
</header>

<!-- Floating search -->
<div class="floating-search" role="search">
  <input id="globalSearch" placeholder="Search: Pok√©mon, TeamLab, matcha, mochi, food, city..." aria-label="Search places"/>
  <button class="btn" id="openAdmin">Admin</button>
</div>

<!-- Map -->
<div id="map" aria-label="Japan map"></div>

<!-- Main content -->
<div class="main-wrap">
  <div class="controls">
    <select id="categoryFilter" class="select">
      <option value="">All categories</option>
    </select>

    <select id="prefFilter" class="select">
      <option value="">All prefectures</option>
    </select>

    <button id="clearFilters" class="select">Clear</button>
    <button id="exportCsv" class="select">Export CSV</button>
    <button id="importBtn" class="select">Import JSON/CSV</button>
  </div>

  <div class="places-grid" id="placesGrid" aria-live="polite"></div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav">
  <button onclick="window.scrollTo({top:0,behavior:'smooth'})">üè† Home</button>
  <button onclick="map.setView([35.6762,139.6503],5)">üó∫Ô∏è Map</button>
  <button onclick="document.querySelector('#categoryFilter').scrollIntoView({behavior:'smooth'})">üìÇ Categories</button>
</div>

<!-- Admin modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Manage Places (JSON) ‚Äî Admin</h3>
    <div class="small">Edit the JSON array of places. Minimal fields: id,name,lat,lng,city,prefecture,category,description. Save to update map.</div>
    <textarea id="jsonEditor" class="textarea" aria-label="JSON editor"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="saveJson" class="select">Save</button>
      <button id="downloadJson" class="select">Download JSON</button>
      <button id="closeModal" class="select">Close</button>
      <button id="resetSample" class="select">Reset Sample</button>
    </div>
  </div>
</div>

<!-- Hidden file input for import -->
<input type="file" id="fileInput" accept=".json,.csv,text/csv" style="display:none"/>

<!-- Leaflet JS + MarkerCluster -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* =========================
   Japan Explorer ‚Äî Main JS
   Single-file app, editable data
   ========================= */

const TIKTOK_HANDLE = "@Muchan_official";

/* Utility helpers */
function uid(){ return 'id' + Math.random().toString(36).slice(2,9); }
function downloadFile(name, text){ const blob=new Blob([text],{type:'application/octet-stream'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }
function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function validNumber(n){ return typeof n === 'number' && isFinite(n) && Math.abs(n) < 1000; }

/* Map initialization */
const map = L.map('map', {minZoom:3, maxZoom:19}).setView([36.2048, 138.2529], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
const markerGroup = L.markerClusterGroup({chunkedLoading:true});
map.addLayer(markerGroup);

/* ========== Sample places (curated) ===========
   Each place: id, name, lat, lng, city, prefecture, category, description, tags[], image, affiliate, pokemon_center
   You can edit via Manage Data modal (JSON).
============================================= */

const SAMPLE_PLACES = [
  { id:'pokecenter_tokyo_dx', name:'Pok√©mon Center TOKYO DX', lat:35.6695, lng:139.7626, city:'Chiyoda', prefecture:'Tokyo', category:'pokemon', description:'Official Pok√©mon Center & caf√© ‚Äî great for merch and booster boxes.', tags:['pokemon','shop','tokyo'], image:'', affiliate:'', pokemon_center:true },
  { id:'pokecenter_shibuya', name:'Pok√©mon Center Shibuya', lat:35.6595, lng:139.7005, city:'Shibuya', prefecture:'Tokyo', category:'pokemon', description:'Pok√©mon Center in Shibuya with seasonal items.', tags:['pokemon','shibuya'], image:'', affiliate:'', pokemon_center:true },
  { id:'teamlab_planets', name:'teamLab Planets', lat:35.6261, lng:139.7817, city:'Toyosu', prefecture:'Tokyo', category:'fun', description:'Walk-through water-based immersive installations ‚Äî viral on social.', tags:['teamlab','planets'], image:'', affiliate:'' },
  { id:'teamlab_borderless', name:'teamLab Borderless', lat:35.6269, lng:139.7769, city:'Odaiba', prefecture:'Tokyo', category:'fun', description:'Large interactive digital art museum (check current exhibition).', tags:['teamlab','borderless'], image:'', affiliate:'' },
  { id:'shibuya_crossing', name:'Shibuya Crossing', lat:35.6595, lng:139.7005, city:'Shibuya', prefecture:'Tokyo', category:'attraction', description:'Iconic scramble crossing ‚Äî great for short-form videos.', tags:['shibuya','crossing'], image:'', affiliate:'' },
  { id:'sensoji_asakusa', name:'Senso-ji (Asakusa)', lat:35.7148, lng:139.7967, city:'Asakusa', prefecture:'Tokyo', category:'culture', description:'Historic temple and Nakamise shopping street.', tags:['temple','asakusa'], image:'', affiliate:'' },
  { id:'akihabara_elec', name:'Akihabara Electric Town', lat:35.6984, lng:139.7730, city:'Akihabara', prefecture:'Tokyo', category:'anime', description:'Arcades, anime shops, card stores and gachapon heaven.', tags:['akihabara','anime'], image:'', affiliate:'' },
  { id:'ueno_park', name:'Ueno Park', lat:35.7138, lng:139.7745, city:'Ueno', prefecture:'Tokyo', category:'culture', description:'Museums, zoo and sakura in spring.', tags:['ueno','museum'], image:'', affiliate:'' },
  { id:'ichiran_shibuya', name:'Ichiran Ramen (Shibuya)', lat:35.6590, lng:139.6993, city:'Shibuya', prefecture:'Tokyo', category:'food', description:'Famous ramen chain with solo booths.', tags:['ramen','food'], image:'', affiliate:'' },
  { id:'nakano_broadway', name:'Nakano Broadway', lat:35.7074, lng:139.6646, city:'Nakano', prefecture:'Tokyo', category:'anime', description:'Collectibles, vintage anime goods and card shops.', tags:['nakano','collectibles'], image:'', affiliate:'' },
  { id:'tokyo_station_ramen', name:'Tokyo Station Ramen Street', lat:35.6812, lng:139.7671, city:'Chiyoda', prefecture:'Tokyo', category:'food', description:'Multiple famous ramen counters inside Tokyo Station.', tags:['ramen','station'], image:'', affiliate':'' },
  { id:'hakone_onsen', name:'Hakone Onsen Area', lat:35.2428, lng:139.1063, city:'Hakone', prefecture:'Kanagawa', category:'onsen', description:'Hot springs and ryokan with views of Mt. Fuji on clear days.', tags:['onsen','hakone'], image:'', affiliate:'' },
  { id:'dotonbori', name:'Dotonbori (Osaka)', lat:34.6687, lng:135.5011, city:'Namba', prefecture:'Osaka', category:'food', description:'Bustling food street ‚Äî takoyaki, okonomiyaki and neon signs.', tags:['osaka','food'], image:'', affiliate:'' },
  { id:'universal_osaka', name:'Universal Studios Japan', lat:34.6654, lng:135.4300, city:'Konohana', prefecture:'Osaka', category:'attraction', description:'Major theme park with seasonal events.', tags:['usj','themepark'], image:'', affiliate:'' },
  { id:'kuromon', name:'Kuromon Market', lat:34.6698, lng:135.5031, city:'Chuo', prefecture:'Osaka', category:'food', description:'Fresh seafood and street snacks.', tags:['market','osaka'], image:'', affiliate:'' },
  { id:'fushimi_inari', name:'Fushimi Inari Taisha', lat:34.9671, lng:135.7727, city:'Fushimi', prefecture:'Kyoto', category:'culture', description:'Thousand torii gates ‚Äî sunrise or early morning is best.', tags:['kyoto','shrine'], image:'', affiliate:'' },
  { id:'gion', name:'Gion (Kyoto)', lat:35.0037, lng:135.7788, city:'Gion', prefecture:'Kyoto', category:'local', description:'Historical geisha district and tea houses.', tags:['gion','kyoto'], image:'', affiliate:'' },
  { id:'kinkakuji', name:'Kinkaku-ji (Golden Pavilion)', lat:35.0394, lng:135.7292, city:'Kita', prefecture:'Kyoto', category:'sightseeing', description:'The famous gold-covered temple.', tags:['kyoto','temple'], image:'', affiliate:'' },
  { id:'arashiyama', name:'Arashiyama Bamboo Grove', lat:35.0094, lng:135.6660, city:'Arashiyama', prefecture:'Kyoto', category:'sightseeing', description:'Famous bamboo grove walkway.', tags:['bamboo','kyoto'], image:'', affiliate:'' },
  { id:'kyoto_matcha', name:'Matcha Ceremony (Gion)', lat:35.0037, lng:135.7788, city:'Gion', prefecture:'Kyoto', category:'matcha', description:'Traditional tea ceremony experiences in Kyoto.', tags:['matcha','tea'], image:'', affiliate:'' },
  { id:'nara_park', name:'Nara Park', lat:34.6851, lng:135.8050, city:'Nara', prefecture:'Nara', category:'sightseeing', description:'Friendly deer and temples like Todai-ji.', tags:['nara','deer'], image:'', affiliate:'' },
  { id:'hiroshima_peace', name:'Hiroshima Peace Memorial Park', lat:34.3853, lng:132.4553, city:'Hiroshima', prefecture:'Hiroshima', category:'culture', description:'Peace museum and memorial.', tags:['hiroshima','peace'], image:'', affiliate:'' },
  { id:'miyajima', name:'Itsukushima Shrine (Miyajima)', lat:34.2950, lng:132.3190, city:'Miyajima', prefecture:'Hiroshima', category:'sightseeing', description:'Iconic floating torii gate.', tags:['miyajima','torii'], image:'', affiliate:'' },
  { id:'sapporo_snow', name:'Sapporo Snow Festival (seasonal)', lat:43.0642, lng:141.3469, city:'Sapporo', prefecture:'Hokkaido', category:'attraction', description:'Winter ice sculptures and events.', tags:['sapporo','festival'], image:'', affiliate:'' },
  { id:'hakata_ramen', name:'Hakata Ramen District', lat:33.5904, lng:130.4017, city:'Hakata', prefecture:'Fukuoka', category:'food', description:'Tonkotsu ramen specialty area.', tags:['ramen','fukuoka'], image:'', affiliate:'' },
  { id:'beppu', name:'Beppu Onsen', lat:33.2786, lng:131.5001, city:'Beppu', prefecture:'Oita', category:'onsen', description:'Famous hot springs and the ‚Äúhells‚Äù tour.', tags:['beppu','onsen'], image:'', affiliate:'' },
  { id:'takayama_old', name:'Takayama Old Town', lat:36.1408, lng:137.2529, city:'Takayama', prefecture:'Gifu', category:'local', description:'Traditional town and markets.', tags:['takayama','history'], image:'', affiliate:'' },
  { id:'kanazawa_teahouse', name:'Kanazawa Tea House (local)', lat:36.5613, lng:136.6562, city:'Kanazawa', prefecture:'Ishikawa', category:'local', description:'Local tea house with regional sweets.', tags:['kanazawa','tea'], image:'', affiliate:'' },
  { id:'nakano_broadway_cards', name:'Nakano Broadway (Cards & Anime)', lat:35.7074, lng:139.6646, city:'Nakano', prefecture:'Tokyo', category:'cards', description:'Card shops, collectors and vintage anime goods.', tags:['cards','nakano'], image:'', affiliate:'' },
  { id:'akihabara_cards', name:'Akihabara Card Shops', lat:35.6984, lng:139.7730, city:'Akihabara', prefecture:'Tokyo', category:'cards', description:'Multiple TCG stores selling singles and booster boxes.', tags:['cards','akihabara'], image:'', affiliate:'' },
  { id:'teamlab_kyoto', name:'teamLab Kyoto (exhibitions)', lat:35.0116, lng:135.7681, city:'Kyoto', prefecture:'Kyoto', category:'fun', description:'teamLab rotating exhibitions in Kyoto area.', tags:['teamlab','kyoto'], image:'', affiliate:'' },
  { id:'onigiri_local', name:'Hidden Onigiri Shop (Local)', lat:35.6768, lng:139.6504, city:'Tokyo', prefecture:'Tokyo', category:'local', description:'Small neighborhood shop with handmade onigiri.', tags:['food','local'], image:'', affiliate:'' },
  { id:'kanazawa_crafts', name:'Kanazawa Crafts & Wajima', lat:36.5613, lng:136.6562, city:'Kanazawa', prefecture:'Ishikawa', category:'culture', description:'Traditional crafts, gold leaf and tea.', tags:['crafts','kanazawa'], image:'', affiliate:'' }
];

/* Persistence: try load from localStorage, else use SAMPLE_PLACES */
const STORAGE_KEY = 'jp_explorer_places_v1';
let PLACES = (function load(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed) && parsed.length) return parsed;
    }
  } catch(e){}
  localStorage.setItem(STORAGE_KEY, JSON.stringify(SAMPLE_PLACES));
  return JSON.parse(JSON.stringify(SAMPLE_PLACES));
})();

/* Add markers from array */
function clearMarkers(){ markerGroup.clearLayers(); }
function addMarkers(list){
  clearMarkers();
  list.forEach(p=>{
    if (!validNumber(Number(p.lat)) || !validNumber(Number(p.lng))) return;
    try {
      const marker = L.marker([p.lat,p.lng], {title:p.name});
      const popup = document.createElement('div');
      popup.style.maxWidth = '300px';
      let html = `<h3 style="margin:0 0 6px">${escapeHtml(p.name)}</h3>`;
      html += `<div style="color:${'#6b7280'};font-size:13px">${escapeHtml(p.city)} ¬∑ ${escapeHtml(p.prefecture)} ¬∑ ${escapeHtml(p.category)}</div>`;
      html += `<p style="margin-top:8px;color:#111">${escapeHtml(p.description)}</p>`;
      html += `<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">`;
      html += `<a class="btn" href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}" target="_blank">Directions</a>`;
      html += `<button class="btn" data-id="${escapeHtml(p.id)}" onclick="sharePlace('${escapeHtml(p.id)}')">Share</button>`;
      if (p.affiliate) html += `<a class="btn" href="${escapeHtml(p.affiliate)}" target="_blank">Buy</a>`;
      html += `</div>`;
      marker.bindPopup(html);
      marker.options.placeId = p.id;
      markerGroup.addLayer(marker);
    } catch(e){
      console.warn('marker error', e, p);
    }
  });
}

/* Render list UI */
const placesGrid = document.getElementById('placesGrid');
function renderList(list){
  placesGrid.innerHTML = '';
  if (!list.length){
    placesGrid.innerHTML = `<div class="small">No results. Try clearing filters.</div>`;
    return;
  }
  list.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'place-card';
    const thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.innerText = (p.category||'').slice(0,2).toUpperCase();
    const meta = document.createElement('div'); meta.style.flex = '1';
    const h = document.createElement('h3'); h.innerText = p.name;
    const sub = document.createElement('div'); sub.className = 'small'; sub.innerText = `${p.city || ''} ¬∑ ${p.prefecture || ''} ¬∑ ${p.category || ''}`;
    const desc = document.createElement('p'); desc.innerText = p.description || '';
    const actions = document.createElement('div'); actions.className = 'actions';
    const openNav = document.createElement('a'); openNav.className = 'btn'; openNav.href = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`; openNav.target='_blank'; openNav.innerText = 'Open in Maps';
    const shareBtn = document.createElement('button'); shareBtn.className = 'btn'; shareBtn.innerText = 'Share'; shareBtn.onclick = ()=> sharePlace(p.id);
    actions.appendChild(openNav); actions.appendChild(shareBtn);
    meta.appendChild(h); meta.appendChild(sub); meta.appendChild(desc); meta.appendChild(actions);
    card.appendChild(thumb); card.appendChild(meta);
    placesGrid.appendChild(card);
  });
}

/* Filters and UI wiring */
const categoryFilter = document.getElementById('categoryFilter');
const prefFilter = document.getElementById('prefFilter');
const globalSearch = document.getElementById('globalSearch');

function populateFilters(){
  const cats = Array.from(new Set(PLACES.map(p=>p.category).filter(Boolean))).sort();
  categoryFilter.innerHTML = '<option value="">All categories</option>' + cats.map(c=>`<option value="${c}">${c[0].toUpperCase()+c.slice(1)}</option>`).join('');
  const prefs = Array.from(new Set(PLACES.map(p=>p.prefecture).filter(Boolean))).sort();
  prefFilter.innerHTML = '<option value="">All prefectures</option>' + prefs.map(p=>`<option value="${p}">${p}</option>`).join('');
}

function getFiltered(){
  const q = (globalSearch.value || '').toLowerCase().trim();
  const cat = categoryFilter.value;
  const pref = prefFilter.value;
  return PLACES.filter(p=>{
    if (cat && p.category !== cat) return false;
    if (pref && p.prefecture !== pref && p.city !== pref) return false;
    if (!q) return true;
    const hay = (p.name+' '+p.city+' '+p.prefecture+' '+(p.tags||[]).join(' ')+' '+p.description).toLowerCase();
    return hay.includes(q);
  });
}

function applyFilters(){
  const filtered = getFiltered();
  addMarkers(filtered);
  renderList(filtered);
}

/* Share function ‚Äî copies TikTok-ready caption */
function sharePlace(id){
  const base = window.location.href.split('#')[0];
  const url = base + '#place=' + encodeURIComponent(id) + '&ref=muchan_official';
  const p = PLACES.find(x=>x.id===id) || {name:'Place'};
  const caption = `${p.name} ‚Äî found on ${TIKTOK_HANDLE}\n${url}\n#Japan #Travel #${TIKTOK_HANDLE.replace('@','')}`;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(caption).then(()=> alert('Caption copied! Paste into TikTok.'));
  } else {
    prompt('Copy this caption', caption);
  }
}

/* Deep-link handling (#place=id) */
function handleHash(){
  const h = location.hash.slice(1);
  if (!h) return;
  const params = new URLSearchParams(h.replace('?',''));
  const pid = params.get('place');
  if (pid){
    const p = PLACES.find(x=>x.id === pid);
    if (p && validNumber(Number(p.lat)) && validNumber(Number(p.lng))){
      map.setView([p.lat,p.lng], 14);
      setTimeout(()=> markerGroup.eachLayer(l => { if (l.options.placeId === pid) l.openPopup(); }), 400);
    }
  }
}

/* Manage Data modal (JSON editor) */
const modal = document.getElementById('modal');
const jsonEditor = document.getElementById('jsonEditor');
document.getElementById('manageBtn').addEventListener('click', openManage);
document.getElementById('openAdmin').addEventListener('click', openManage);

function openManage(){
  jsonEditor.value = JSON.stringify(PLACES, null, 2);
  modal.style.display = 'flex';
}
document.getElementById('closeModal').addEventListener('click', ()=> modal.style.display = 'none');
document.getElementById('saveJson').addEventListener('click', ()=> {
  try {
    const parsed = JSON.parse(jsonEditor.value);
    if (!Array.isArray(parsed)) return alert('JSON must be an array of places');
    // minimal validation
    for (let i=0;i<parsed.length;i++){
      const it = parsed[i];
      if (!it.id) it.id = uid();
      if (!validNumber(Number(it.lat)) || !validNumber(Number(it.lng))) return alert('Invalid lat/lng at item index '+i);
    }
    PLACES = parsed;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(PLACES));
    populateFilters();
    applyFilters();
    modal.style.display = 'none';
    alert('Saved ' + PLACES.length + ' places locally in your browser.');
  } catch(e){ alert('Invalid JSON: ' + e.message); }
});
document.getElementById('downloadJson').addEventListener('click', ()=> { downloadFile('places.json', JSON.stringify(PLACES, null, 2)); });

/* Reset sample - restore built-in sample */
document.getElementById('resetSample').addEventListener('click', ()=> {
  if (!confirm('Replace current list with built-in sample?')) return;
  PLACES = JSON.parse(JSON.stringify(SAMPLE_PLACES));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(PLACES));
  populateFilters();
  applyFilters();
  alert('Restored sample places.');
});

/* Export CSV */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  const headers = ['id','name','lat','lng','city','prefecture','category','description','tags','affiliate','pokemon_center'];
  const rows = PLACES.map(p => headers.map(h=>{
    const v = p[h];
    if (Array.isArray(v)) return `"${v.join('|')}"`;
    return `"${String(v||'').replace(/"/g,'""')}"`;
  }).join(','));
  const csv = headers.join(',') + '\n' + rows.join('\n');
  downloadFile('places_export.csv', csv);
});

/* Import file */
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const text = reader.result;
    try {
      if (text.trim().startsWith('[') || text.trim().startsWith('{')){
        const parsed = JSON.parse(text);
        const arr = Array.isArray(parsed) ? parsed : [parsed];
        let added = 0;
        arr.forEach(it=>{
          if (!it.id) it.id = uid();
          if (!validNumber(Number(it.lat)) || !validNumber(Number(it.lng))) return;
          PLACES.push(it); added++;
        });
        if (added){ localStorage.setItem(STORAGE_KEY, JSON.stringify(PLACES)); populateFilters(); applyFilters(); alert('Imported ' + added + ' items'); }
        else alert('No valid items found to import.');
      } else {
        // attempt CSV parse (very basic)
        const lines = text.split(/\r?\n/).filter(Boolean);
        const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
        let added = 0;
        for (let i=1;i<lines.length;i++){
          const cols = lines[i].split(',');
          if (!cols.length) continue;
          const obj = {};
          headers.forEach((h, idx)=> obj[h] = cols[idx] ? cols[idx].trim().replace(/^"|"$/g,'') : '');
          const lat = Number(obj.lat || obj.latitude || '');
          const lng = Number(obj.lng || obj.longitude || '');
          if (!validNumber(lat) || !validNumber(lng)) continue;
          PLACES.push({ id: obj.id || uid(), name: obj.name || 'Imported', lat, lng, city: obj.city||'', prefecture: obj.prefecture||'', category: obj.category||'local', description: obj.description||'', tags: (obj.tags? obj.tags.split('|'):[]), affiliate: obj.affiliate || '', pokemon_center: (obj.pokemon_center==='true') });
          added++;
        }
        if (added){ localStorage.setItem(STORAGE_KEY, JSON.stringify(PLACES)); populateFilters(); applyFilters(); alert('Imported ' + added + ' CSV rows'); }
        else alert('No CSV rows imported');
      }
    } catch(e){ alert('Import failed: ' + e.message); }
  };
  reader.readAsText(f);
  ev.target.value = '';
});

/* Filters events */
globalSearch.addEventListener('input', applyFilters);
categoryFilter.addEventListener('change', applyFilters);
prefFilter.addEventListener('change', applyFilters);
document.getElementById('clearFilters').addEventListener('click', ()=> {
  globalSearch.value=''; categoryFilter.value=''; prefFilter.value=''; applyFilters();
});

/* Dark mode toggle */
function toggleDark(){ document.body.classList.toggle('dark'); }
window.toggleDark = toggleDark;

/* Init UI and markers */
populateFilters();
applyFilters();
handleHash();
setTimeout(()=>{ const ls = document.getElementById('loading-screen'); if (ls) ls.style.display='none'; }, 1800);

/* Expose small debug API on window */
window.JAPAN_EXPLORER = {
  getPlaces: ()=> JSON.parse(JSON.stringify(PLACES)),
  setPlaces: (arr)=> { if (!Array.isArray(arr)) throw new Error('array required'); PLACES = arr; localStorage.setItem(STORAGE_KEY, JSON.stringify(PLACES)); populateFilters(); applyFilters(); }
};

console.log('Japan Explorer ready ‚Äî Muchan_official');
</script>

</body>
</html>