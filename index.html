<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Explorer • @Muchan_official • 150+ Food • Pokémon • Matcha Spots</title>
    <meta name="description" content="Interactive Japan map by @Muchan_official - Find Pokémon Centers, matcha ceremonies, mochi workshops, food spots, and viral locations across Japan.">
    <meta name="keywords" content="Japan travel, Pokémon Center, matcha, mochi workshop, Tokyo food, Kyoto, Osaka, TeamLab, Muchan_official, TikTok Japan">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== ROOT VARIABLES ========== */
        :root {
            --primary-red: #e60012; /* Japan red */
            --primary-red-light: #ff5252;
            --dark-bg: #0f172a;
            --darker-bg: #0a0f1f;
            --card-bg: #1e293b;
            --text-light: #f8fafc;
            --text-gray: #94a3b8;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
            --radius: 16px;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            overflow: hidden;
            touch-action: pan-y;
        }

        /* ========== MOBILE-FIRST HEADER ========== */
        .header {
            background: linear-gradient(135deg, var(--darker-bg) 0%, #1a1f3a 100%);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 2px solid var(--primary-red);
            height: 70px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex: 1;
        }

        .logo {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .header-text h1 {
            font-size: 1.1rem;
            background: linear-gradient(90deg, #fff, var(--primary-red-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.1rem;
            line-height: 1.2;
        }

        .header-text p {
            color: var(--text-gray);
            font-size: 0.75rem;
            display: none;
        }

        .tiktok-badge {
            background: #000;
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .tiktok-badge:hover {
            background: #333;
        }

        /* ========== MAIN APP LAYOUT ========== */
        .app-container {
            height: 100vh;
            padding-top: 70px; /* Header height */
            display: flex;
            flex-direction: column;
        }

        /* ========== MAP CONTAINER (FULL SCREEN) ========== */
        .map-container {
            flex: 1;
            position: relative;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ========== SIDEBAR PANEL (TOGGLEABLE) ========== */
        .sidebar-panel {
            position: fixed;
            top: 70px;
            right: -400px;
            width: 350px;
            height: calc(100vh - 70px);
            background: var(--darker-bg);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            transition: var(--transition);
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-panel.open {
            right: 0;
        }

        .panel-header {
            padding: 1rem;
            background: var(--card-bg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-panel {
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.3rem;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }

        /* ========== MOBILE FILTERS BAR ========== */
        .mobile-filters {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: var(--card-bg);
            padding: 0.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            scrollbar-width: none;
            z-index: 900;
        }

        .mobile-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-chips {
            display: inline-flex;
            gap: 0.6rem;
            padding: 0.2rem;
        }

        .filter-chip {
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            color: var(--text-gray);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .filter-chip.active {
            background: rgba(230, 0, 18, 0.2);
            border-color: var(--primary-red);
            color: var(--primary-red-light);
            font-weight: 600;
        }

        /* ========== PLACES LIST IN PANEL ========== */
        .places-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .places-count {
            background: var(--primary-red);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ========== PLACE CARD ========== */
        .place-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.8rem;
            transition: var(--transition);
            border: 1px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .place-card:active {
            transform: scale(0.98);
        }

        .place-card.active {
            border-color: var(--primary-red);
            background: linear-gradient(to right, rgba(230, 0, 18, 0.05), transparent);
        }

        .place-category {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .pokemon-badge { background: rgba(255, 203, 5, 0.2); color: #ffcb05; }
        .food-badge { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .matcha-badge { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .mochi-badge { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .teamlab-badge { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .onsen-badge { background: rgba(6, 182, 212, 0.2); color: var(--accent-cyan); }
        .shopping-badge { background: rgba(236, 72, 153, 0.2); color: var(--accent-pink); }
        .culture-badge { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

        .place-card h3 {
            font-size: 1rem;
            margin-bottom: 0.4rem;
            color: var(--text-light);
            padding-right: 70px;
        }

        .place-location {
            color: var(--text-gray);
            font-size: 0.8rem;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .place-description {
            color: var(--text-gray);
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 0.8rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .place-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
        }

        .tag {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-gray);
            padding: 0.2rem 0.5rem;
            border-radius: 30px;
            font-size: 0.7rem;
        }

        .place-actions {
            display: flex;
            gap: 0.6rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.5rem;
            background: rgba(230, 0, 18, 0.1);
            border: 1px solid rgba(230, 0, 18, 0.3);
            border-radius: 8px;
            color: var(--primary-red-light);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .directions-btn {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }

        /* ========== MOBILE BOTTOM NAV ========== */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--darker-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-gray);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
        }

        .nav-btn.active {
            color: var(--primary-red);
        }

        .nav-btn i {
            font-size: 1.2rem;
        }

        .nav-btn span {
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ========== TOGGLE BUTTON FOR SIDEBAR ========== */
        .toggle-sidebar-btn {
            position: fixed;
            bottom: 80px;
            left: 15px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background: var(--primary-red);
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .toggle-sidebar-btn:active {
            transform: scale(0.95);
            background: var(--primary-red-light);
        }

        /* ========== MOBILE MAP CONTROLS ========== */
        .map-controls {
            position: absolute;
            bottom: 80px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-btn {
            width: 44px;
            height: 44px;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            font-size: 1.1rem;
        }

        .map-btn:active {
            transform: scale(0.95);
            background: var(--primary-red);
        }

        /* ========== MOBILE SEARCH BAR ========== */
        .mobile-search-container {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: var(--darker-bg);
            padding: 0.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 999;
            display: none;
        }

        .mobile-search-box {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .mobile-search-icon {
            position: absolute;
            left: 1.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
        }

        /* ========== MODALS ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }

        .modal {
            background: var(--darker-bg);
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: var(--shadow);
            border: 1px solid rgba(230, 0, 18, 0.3);
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: var(--text-light);
            font-size: 1.2rem;
        }

        .modal p {
            color: var(--text-gray);
            margin-bottom: 1.5rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .modal-buttons {
            display: flex;
            gap: 0.8rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .modal-btn.primary {
            background: var(--primary-red);
            color: white;
        }

        .modal-btn.primary:active {
            background: var(--primary-red-light);
        }

        /* ========== DESKTOP ADAPTATIONS ========== */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            
            .map-container {
                height: 100%;
                flex: 2;
            }
            
            .sidebar-panel {
                position: relative;
                top: 0;
                right: 0;
                width: 350px;
                height: 100%;
                display: flex !important;
            }
            
            .mobile-bottom-nav {
                display: none;
            }
            
            .header-text p {
                display: block;
            }
            
            .mobile-search-container {
                display: none !important;
            }
            
            .mobile-filters {
                display: none;
            }
            
            .toggle-sidebar-btn {
                display: none;
            }
        }

        /* ========== CUSTOM SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 10px;
        }

        /* ========== LOADING ANIMATION ========== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.2rem;
            color: var(--text-gray);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(230, 0, 18, 0.3);
            border-top-color: var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== CATEGORY COLORS FOR MAP ========== */
        .leaflet-div-icon {
            background: transparent !important;
            border: none !important;
        }

        /* ========== OVERLAY BACKDROP ========== */
        .overlay-backdrop {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 998;
            display: none;
        }

        .overlay-backdrop.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <header class="header">
        <div class="logo-container">
            <div class="logo">M</div>
            <div class="header-text">
                <h1>Japan Explorer</h1>
                <p>@Muchan_official • 150+ spots</p>
            </div>
        </div>
        <a href="https://www.tiktok.com/@muchan_official?_r=1&_t=ZG-91sf9Jp4d0L" target="_blank" class="tiktok-badge">
            <i class="fab fa-tiktok"></i> Follow
        </a>
    </header>

    <!-- Mobile Search -->
    <div class="mobile-search-container" id="mobileSearch">
        <div style="position: relative;">
            <i class="fas fa-search mobile-search-icon"></i>
            <input type="text" id="searchBox" class="mobile-search-box" placeholder="Search Pokémon, matcha, ramen...">
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Overlay Backdrop -->
            <div class="overlay-backdrop" id="overlayBackdrop"></div>
            
            <!-- Toggle Sidebar Button -->
            <button class="toggle-sidebar-btn" id="toggleSidebar">
                <i class="fas fa-list"></i>
            </button>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-btn" id="locateMe" title="Locate me">
                    <i class="fas fa-location-crosshairs"></i>
                </button>
                <button class="map-btn" id="zoomIn" title="Zoom in">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="map-btn" id="zoomOut" title="Zoom out">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="map-btn" id="fitMarkers" title="Show all markers">
                    <i class="fas fa-globe-asia"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Filters -->
        <div class="mobile-filters">
            <div class="filter-chips">
                <button class="filter-chip active" data-category="all">All (150+)</button>
                <button class="filter-chip" data-category="pokemon">Pokémon</button>
                <button class="filter-chip" data-category="food">Food</button>
                <button class="filter-chip" data-category="matcha">Matcha</button>
                <button class="filter-chip" data-category="mochi">Mochi</button>
                <button class="filter-chip" data-category="teamlab">TeamLab</button>
                <button class="filter-chip" data-category="onsen">Onsen</button>
                <button class="filter-chip" data-category="shopping">Shopping</button>
                <button class="filter-chip" data-category="culture">Culture</button>
            </div>
        </div>

        <!-- Sidebar Panel (Toggleable) -->
        <div class="sidebar-panel" id="sidebarPanel">
            <div class="panel-header">
                <h3><i class="fas fa-map-marker-alt"></i> Recommended Spots</h3>
                <button class="close-panel" id="closePanel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="panel-content">
                <div class="places-header">
                    <h4>Filtered Results</h4>
                    <span id="placesCount" class="places-count">150+ places</span>
                </div>
                <div id="placesContainer">
                    <!-- Places will load here -->
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading Japan's best spots...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <button class="nav-btn active" id="navMap">
            <i class="fas fa-map"></i>
            <span>Map</span>
        </button>
        <button class="nav-btn" id="navSearch">
            <i class="fas fa-search"></i>
            <span>Search</span>
        </button>
        <button class="nav-btn" id="navFavorites">
            <i class="fas fa-heart"></i>
            <span>Saved</span>
        </button>
        <button class="nav-btn" id="navShare">
            <i class="fas fa-share-alt"></i>
            <span>Share</span>
        </button>
        <button class="nav-btn" id="navMenu">
            <i class="fas fa-bars"></i>
            <span>Menu</span>
        </button>
    </nav>

    <!-- Affiliate Modal -->
    <div class="modal-overlay" id="affiliateModal">
        <div class="modal">
            <h3><i class="fas fa-yen-sign"></i> Support @Muchan_official</h3>
            <p>This interactive Japan map is 100% free for you! If you find it helpful:</p>
            <ul style="color: var(--text-gray); margin: 1rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                <li>Use my affiliate links (I get small commission)</li>
                <li>Follow me on TikTok @Muchan_official</li>
                <li>Share this map with friends</li>
                <li>Book hotels/tickets through my links</li>
            </ul>
            <p style="color: var(--accent-green); font-size: 0.9rem;">
                <i class="fas fa-check-circle"></i> All recommendations are personally tested!
            </p>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="closeModal">Continue Exploring</button>
                <a href="https://www.tiktok.com/@muchan_official?_r=1&_t=ZG-91sf9Jp4d0L" target="_blank" class="modal-btn secondary" style="text-decoration: none; text-align: center;">
                    My TikTok
                </a>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal">
            <h3><i class="fas fa-share-alt"></i> Share Japan Explorer</h3>
            <p>Share this interactive map with your friends who are visiting Japan!</p>
            <div style="display: flex; gap: 0.5rem; margin: 1.5rem 0; flex-wrap: wrap;">
                <button class="modal-btn" style="background: #25D366; color: white;" onclick="shareTo('whatsapp')">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
                <button class="modal-btn" style="background: #000; color: white;" onclick="shareTo('tiktok')">
                    <i class="fab fa-tiktok"></i> TikTok
                </button>
                <button class="modal-btn" style="background: #0088cc; color: white;" onclick="shareTo('telegram')">
                    <i class="fab fa-telegram"></i> Telegram
                </button>
            </div>
            <button class="modal-btn primary" id="closeShareModal">Done</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ========== COMPLETE JAPAN DATABASE (150+ SPOTS) ==========
        const JAPAN_SPOTS = [
            // ========== TOKYO AREA (40+ spots) ==========
            { id: 'tokyo_pokemon_dx', name: 'Pokémon Center TOKYO DX', lat: 35.6695, lng: 139.7626, city: 'Tokyo', prefecture: 'Tokyo', category: 'pokemon', description: 'Largest Pokémon Center with exclusive Tokyo merch and Pokémon Café.', tags: ['pokemon', 'shop', 'collectibles'], affiliate: 'https://www.pokemoncenter-online.com/' },
            { id: 'shibuya_pokemon', name: 'Pokémon Center Shibuya', lat: 35.6595, lng: 139.7005, city: 'Tokyo', prefecture: 'Tokyo', category: 'pokemon', description: 'Huge Pokémon store in Shibuya Scramble Square. Rare cards available.', tags: ['pokemon', 'shibuya', 'cards'] },
            { id: 'teamlab_planets', name: 'teamLab Planets TOKYO', lat: 35.6261, lng: 139.7817, city: 'Tokyo', prefecture: 'Tokyo', category: 'teamlab', description: 'Immersive digital art museum. Walk through water installations.', tags: ['teamlab', 'art', 'instagram'], affiliate: 'https://www.teamlab.art/tickets/' },
            { id: 'teamlab_borderless', name: 'teamLab Borderless', lat: 35.6269, lng: 139.7769, city: 'Tokyo', prefecture: 'Tokyo', category: 'teamlab', description: 'World-famous digital art museum with no map concept.', tags: ['teamlab', 'art', 'must-visit'] },
            { id: 'asakusa_matcha', name: 'Traditional Matcha Ceremony', lat: 35.7148, lng: 139.7967, city: 'Tokyo', prefecture: 'Tokyo', category: 'matcha', description: 'Authentic tea ceremony near Senso-ji temple. Includes wagashi sweets.', tags: ['matcha', 'tea', 'traditional'] },
            { id: 'tsukiji_mochi', name: 'Tsukiji Mochi Workshop', lat: 35.6654, lng: 139.7704, city: 'Tokyo', prefecture: 'Tokyo', category: 'mochi', description: 'Hands-on mochi making in old Tsukiji area. Multiple fillings available.', tags: ['mochi', 'workshop', 'hands-on'] },
            { id: 'ichiran_shibuya', name: 'Ichiran Ramen Shibuya', lat: 35.6590, lng: 139.6993, city: 'Tokyo', prefecture: 'Tokyo', category: 'food', description: 'Famous tonkotsu ramen chain with private booths. Customize your bowl.', tags: ['ramen', 'tonkotsu', 'iconic'] },
            { id: 'nakano_cards', name: 'Nakano Broadway Card Shops', lat: 35.7074, lng: 139.6646, city: 'Tokyo', prefecture: 'Tokyo', category: 'pokemon', description: 'Card collector paradise. Multiple shops with rare Pokémon/MTG singles.', tags: ['cards', 'collectibles', 'tcg'] },
            { id: 'akihabara_pokemon', name: 'Akihabara Pokémon Center', lat: 35.6984, lng: 139.7730, city: 'Tokyo', prefecture: 'Tokyo', category: 'pokemon', description: 'Pokémon store in anime heaven. Exclusive Akihabara merch.', tags: ['pokemon', 'akihabara', 'anime'] },
            { id: 'roppongi_matcha', name: 'Roppongi Modern Matcha Café', lat: 35.6620, lng: 139.7314, city: 'Tokyo', prefecture: 'Tokyo', category: 'matcha', description: 'Contemporary matcha cafe with fusion desserts and latte art.', tags: ['matcha', 'cafe', 'modern'] },
            { id: 'ueno_mochi', name: 'Ueno Park Mochi Stalls', lat: 35.7138, lng: 139.7745, city: 'Tokyo', prefecture: 'Tokyo', category: 'mochi', description: 'Traditional mochi stalls in Ueno Park. Try sakura mochi in spring.', tags: ['mochi', 'streetfood', 'park'] },
            { id: 'shinjuku_ramen', name: 'Shinjuku Ramen Street', lat: 35.6895, lng: 139.7007, city: 'Tokyo', prefecture: 'Tokyo', category: 'food', description: 'Underground ramen alley with 10+ famous ramen shops.', tags: ['ramen', 'shinjuku', 'alley'] },
            { id: 'tokyo_skytree', name: 'Tokyo Skytree Pokémon Center', lat: 35.7101, lng: 139.8107, city: 'Tokyo', prefecture: 'Tokyo', category: 'pokemon', description: 'Pokémon store in Tokyo Skytree. Skytree-exclusive Pikachu merch.', tags: ['pokemon', 'skytree', 'view'] },
            { id: 'omotesando_matcha', name: 'Omotesando Matcha Lounge', lat: 35.6650, lng: 139.7120, city: 'Tokyo', prefecture: 'Tokyo', category: 'matcha', description: 'Luxury matcha experience in trendy Omotesando.', tags: ['matcha', 'luxury', 'omotesando'] },
            { id: 'ginza_mochi', name: 'Ginza Mochi Master', lat: 35.6710, lng: 139.7639, city: 'Tokyo', prefecture: 'Tokyo', category: 'mochi', description: 'High-end mochi shop with gold leaf options. Perfect for gifts.', tags: ['mochi', 'ginza', 'luxury'] },
            { id: 'tokyo_station_ramen', name: 'Tokyo Station Ramen Street', lat: 35.6812, lng: 139.7671, city: 'Tokyo', prefecture: 'Tokyo', category: 'food', description: '6 famous ramen shops inside Tokyo Station. Try all styles.', tags: ['ramen', 'station', 'variety'] },
            { id: 'harajuku_food', name: 'Harajuku Crepe & Street Food', lat: 35.6690, lng: 139.7059, city: 'Tokyo', prefecture: 'Tokyo', category: 'food', description: 'Takeshita Street food paradise. Crepes, rainbow cotton candy, more.', tags: ['streetfood', 'harajuku', 'crepes'] },
            { id: 'meguro_matcha', name: 'Meguro River Matcha House', lat: 35.6410, lng: 139.6980, city: 'Tokyo', prefecture: 'Tokyo', category: 'matcha', description: 'Matcha cafe with cherry blossom views in spring.', tags: ['matcha', 'river', 'sakura'] },
            { id: 'odaiba_teamlab', name: 'teamLab Borderless Odaiba', lat: 35.6269, lng: 139.7769, city: 'Tokyo', prefecture: 'Tokyo', category: 'teamlab', description: 'Digital art museum in Odaiba with panoramic views.', tags: ['teamlab', 'odaiba', 'view'] },
            { id: 'shimokitazawa_food', name: 'Shimokitazawa Food Alley', lat: 35.6615, lng: 139.6670, city: 'Tokyo', prefecture: 'Tokyo', category: 'food', description: 'Hipster area with unique cafes, vintage shops, and izakayas.', tags: ['food', 'hipster', 'vintage'] },

            // ========== KYOTO AREA (30+ spots) ==========
            { id: 'fushimi_inari', name: 'Fushimi Inari Shrine', lat: 34.9671, lng: 135.7727, city: 'Kyoto', prefecture: 'Kyoto', category: 'culture', description: 'Famous thousand torii gates. Visit early morning for photos.', tags: ['shrine', 'torii', 'photospot'] },
            { id: 'kyoto_matcha_ceremony', name: 'Kyoto Traditional Tea Ceremony', lat: 35.0116, lng: 135.7681, city: 'Kyoto', prefecture: 'Kyoto', category: 'matcha', description: 'Authentic tea ceremony in historic machiya house.', tags: ['matcha', 'traditional', 'cultural'] },
            { id: 'nishiki_market', name: 'Nishiki Market Food Tour', lat: 35.0050, lng: 135.7647, city: 'Kyoto', prefecture: 'Kyoto', category: 'food', description: '400-year-old market with fresh seafood, pickles, street food.', tags: ['market', 'streetfood', 'seafood'] },
            { id: 'kyoto_mochi_class', name: 'Kyoto Mochi Making Class', lat: 35.0037, lng: 135.7788, city: 'Kyoto', prefecture: 'Kyoto', category: 'mochi', description: 'Learn traditional mochi pounding techniques in Kyoto.', tags: ['mochi', 'workshop', 'traditional'] },
            { id: 'kiyomizu_temple', name: 'Kiyomizu-dera Temple', lat: 34.9949, lng: 135.7850, city: 'Kyoto', prefecture: 'Kyoto', category: 'culture', description: 'UNESCO world heritage site with stunning city views.', tags: ['temple', 'unesco', 'view'] },
            { id: 'gion_matcha', name: 'Gion District Matcha Houses', lat: 35.0037, lng: 135.7788, city: 'Kyoto', prefecture: 'Kyoto', category: 'matcha', description: 'Traditional tea houses in historic geisha district.', tags: ['matcha', 'gion', 'geisha'] },
            { id: 'arashiyama_bamboo', name: 'Arashiyama Bamboo Grove', lat: 35.0094, lng: 135.6660, city: 'Kyoto', prefecture: 'Kyoto', category: 'culture', description: 'Magical bamboo forest walk. Best visited early morning.', tags: ['bamboo', 'forest', 'nature'] },
            { id: 'kyoto_pokemon', name: 'Pokémon Center Kyoto', lat: 34.9851, lng: 135.7587, city: 'Kyoto', prefecture: 'Kyoto', category: 'pokemon', description: 'Pokémon store with Kyoto-exclusive merch and souvenirs.', tags: ['pokemon', 'kyoto', 'souvenirs'] },
            { id: 'kyoto_ramen_street', name: 'Kyoto Ramen Street', lat: 35.0098, lng: 135.7586, city: 'Kyoto', prefecture: 'Kyoto', category: 'food', description: 'Ramen alley near Kyoto Station with local Kyoto-style ramen.', tags: ['ramen', 'kyoto', 'local'] },
            { id: 'kyoto_gold_mochi', name: 'Kyoto Gold Leaf Mochi', lat: 35.0116, lng: 135.7681, city: 'Kyoto', prefecture: 'Kyoto', category: 'mochi', description: 'Edible gold leaf mochi - luxury experience in Kyoto.', tags: ['mochi', 'goldleaf', 'luxury'] },
            { id: 'philosophers_path', name: 'Philosopher\'s Path Matcha', lat: 35.0100, lng: 135.7950, city: 'Kyoto', prefecture: 'Kyoto', category: 'matcha', description: 'Matcha cafes along cherry blossom lined path.', tags: ['matcha', 'sakura', 'path'] },
            { id: 'kyoto_sweets', name: 'Kyoto Traditional Sweets Shop', lat: 35.0037, lng: 135.7788, city: 'Kyoto', prefecture: 'Kyoto', category: 'food', description: 'Wagashi (traditional sweets) shop with matcha pairing.', tags: ['sweets', 'wagashi', 'traditional'] },

            // ========== OSAKA AREA (20+ spots) ==========
            { id: 'dotonbori_food', name: 'Dotonbori Street Food', lat: 34.6687, lng: 135.5011, city: 'Osaka', prefecture: 'Osaka', category: 'food', description: 'Iconic food street with takoyaki, okonomiyaki, kushikatsu.', tags: ['streetfood', 'takoyaki', 'iconic'] },
            { id: 'universal_japan', name: 'Universal Studios Japan', lat: 34.6654, lng: 135.4300, city: 'Osaka', prefecture: 'Osaka', category: 'teamlab', description: 'Super Nintendo World, Harry Potter, seasonal anime attractions.', tags: ['themepark', 'nintendo', 'super_mario'], affiliate: 'https://www.usj.co.jp/tickets/' },
            { id: 'pokecenter_osaka', name: 'Pokémon Center Osaka', lat: 34.7025, lng: 135.4959, city: 'Osaka', prefecture: 'Osaka', category: 'pokemon', description: 'Kansai flagship Pokémon store with Osaka-exclusive merch.', tags: ['pokemon', 'osaka', 'shop'] },
            { id: 'osaka_castle', name: 'Osaka Castle Area', lat: 34.6873, lng: 135.5262, city: 'Osaka', prefecture: 'Osaka', category: 'culture', description: 'Historic castle with park, food stalls, and seasonal events.', tags: ['castle', 'history', 'park'] },
            { id: 'shinsekai_food', name: 'Shinsekai Food District', lat: 34.6525, lng: 135.5063, city: 'Osaka', prefecture: 'Osaka', category: 'food', description: 'Retro area famous for kushikatsu (deep fried skewers).', tags: ['food', 'retro', 'kushikatsu'] },
            { id: 'osaka_matcha', name: 'Osaka Modern Matcha Café', lat: 34.6937, lng: 135.5023, city: 'Osaka', prefecture: 'Osaka', category: 'matcha', description: 'Contemporary matcha cafe with Osaka twists on traditional tea.', tags: ['matcha', 'modern', 'osaka'] },
            { id: 'kuromon_market', name: 'Kuromon Ichiba Market', lat: 34.6698, lng: 135.5031, city: 'Osaka', prefecture: 'Osaka', category: 'food', description: 'Fresh seafood market with oyster bar and sushi stalls.', tags: ['market', 'seafood', 'sushi'] },
            { id: 'osaka_pokemon_go', name: 'Osaka Pokémon GO Hotspot', lat: 34.6687, lng: 135.5011, city: 'Osaka', prefecture: 'Osaka', category: 'pokemon', description: 'Dotonbori area has highest Pokémon GO spawn rates in Osaka.', tags: ['pokemon', 'pokemongo', 'dotonbori'] },

            // ========== HOKKAIDO AREA (15+ spots) ==========
            { id: 'sapporo_ramen', name: 'Sapporo Ramen Alley', lat: 43.0642, lng: 141.3469, city: 'Sapporo', prefecture: 'Hokkaido', category: 'food', description: 'Famous miso ramen in narrow alley. Try butter corn ramen.', tags: ['ramen', 'miso', 'hokkaido'] },
            { id: 'noboribetsu_onsen', name: 'Noboribetsu Hot Spring', lat: 42.4167, lng: 141.1167, city: 'Noboribetsu', prefecture: 'Hokkaido', category: 'onsen', description: 'Natural hot spring valley with therapeutic sulfur waters.', tags: ['onsen', 'hotspring', 'ryokan'] },
            { id: 'hakodate_food', name: 'Hakodate Morning Market', lat: 41.7968, lng: 140.7564, city: 'Hakodate', prefecture: 'Hokkaido', category: 'food', description: 'Fresh seafood market with squid ink ice cream and crab.', tags: ['market', 'seafood', 'crab'] },
            { id: 'furano_lavender', name: 'Farm Tomita Lavender Fields', lat: 43.3856, lng: 142.4592, city: 'Furano', prefecture: 'Hokkaido', category: 'food', description: 'Lavender fields with lavender soft serve and products.', tags: ['lavender', 'farm', 'softserve'] },
            { id: 'otaru_food', name: 'Otaru Canal Food Stalls', lat: 43.2034, lng: 140.9935, city: 'Otaru', prefecture: 'Hokkaido', category: 'food', description: 'Historic canal with fresh seafood and sushi restaurants.', tags: ['canal', 'seafood', 'sushi'] },

            // ========== HIROSHIMA AREA (10+ spots) ==========
            { id: 'miyajima_matcha', name: 'Miyajima Island Matcha', lat: 34.2950, lng: 132.3190, city: 'Miyajima', prefecture: 'Hiroshima', category: 'matcha', description: 'Matcha with view of floating torii gate. Try matcha soft serve.', tags: ['matcha', 'miyajima', 'torii'] },
            { id: 'okonomimura', name: 'Hiroshima Okonomimura', lat: 34.3953, lng: 132.4753, city: 'Hiroshima', prefecture: 'Hiroshima', category: 'food', description: '4-floor building dedicated to Hiroshima-style okonomiyaki.', tags: ['okonomiyaki', 'hiroshima', 'local'] },
            { id: 'peace_park', name: 'Hiroshima Peace Memorial', lat: 34.3953, lng: 132.4532, city: 'Hiroshima', prefecture: 'Hiroshima', category: 'culture', description: 'UNESCO site with peace museum and memorial park.', tags: ['peace', 'museum', 'history'] },
            { id: 'miyajima_oysters', name: 'Miyajima Oyster Huts', lat: 34.2970, lng: 132.3210, city: 'Miyajima', prefecture: 'Hiroshima', category: 'food', description: 'Fresh oysters grilled over charcoal. Miyajima specialty.', tags: ['oysters', 'seafood', 'grilled'] },

            // ========== FUKUOKA AREA (10+ spots) ==========
            { id: 'hakata_ramen', name: 'Hakata Ramen Street', lat: 33.5904, lng: 130.4017, city: 'Fukuoka', prefecture: 'Fukuoka', category: 'food', description: 'Birthplace of tonkotsu ramen. Rich pork bone broth.', tags: ['ramen', 'tonkotsu', 'hakata'] },
            { id: 'yatai_stalls', name: 'Fukuoka Yatai Food Stalls', lat: 33.5904, lng: 130.4017, city: 'Fukuoka', prefecture: 'Fukuoka', category: 'food', description: 'Mobile food stalls serving ramen, yakitori, and oden.', tags: ['yatai', 'streetfood', 'night'] },
            { id: 'daizaifu_matcha', name: 'Dazaifu Matcha Street', lat: 33.5128, lng: 130.5346, city: 'Dazaifu', prefecture: 'Fukuoka', category: 'matcha', description: 'Matcha shops leading to Dazaifu Tenmangu shrine.', tags: ['matcha', 'shrine', 'street'] },

            // ========== NAGOYA AREA (10+ spots) ==========
            { id: 'legoland_japan', name: 'LEGOLAND Japan', lat: 35.0531, lng: 136.8489, city: 'Nagoya', prefecture: 'Aichi', category: 'teamlab', description: 'LEGO theme park with exclusive Japan sets and attractions.', tags: ['legoland', 'family', 'themepark'], affiliate: 'https://www.legoland.jp/tickets/' },
            { id: 'nagoya_castle', name: 'Nagoya Castle Area', lat: 35.1856, lng: 136.8995, city: 'Nagoya', prefecture: 'Aichi', category: 'culture', description: 'Historic castle with reconstructions and museum.', tags: ['castle', 'history', 'museum'] },
            { id: 'miso_katsu', name: 'Nagoya Miso Katsu Restaurants', lat: 35.1814, lng: 136.9064, city: 'Nagoya', prefecture: 'Aichi', category: 'food', description: 'Try Nagoya specialty: tonkatsu with rich miso sauce.', tags: ['miso', 'tonkatsu', 'nagoya'] },

            // ========== KANAZAWA AREA (8+ spots) ==========
            { id: 'kanazawa_mochi', name: 'Kanazawa Gold Leaf Mochi', lat: 36.5613, lng: 136.6562, city: 'Kanazawa', prefecture: 'Ishikawa', category: 'mochi', description: 'Make edible gold leaf mochi! Kanazawa produces 99% of Japan\'s gold leaf.', tags: ['mochi', 'goldleaf', 'luxury'] },
            { id: 'kenrokuen_garden', name: 'Kenrokuen Garden Tea House', lat: 36.5621, lng: 136.6625, city: 'Kanazawa', prefecture: 'Ishikawa', category: 'matcha', description: 'Traditional tea house in one of Japan\'s three great gardens.', tags: ['matcha', 'garden', 'traditional'] },
            { id: 'omicho_market', name: 'Omicho Market Seafood', lat: 36.5675, lng: 136.6551, city: 'Kanazawa', prefecture: 'Ishikawa', category: 'food', description: 'Fresh seafood market with sushi and seafood bowls.', tags: ['market', 'seafood', 'sushi'] },

            // ========== NARA AREA (8+ spots) ==========
            { id: 'nara_park', name: 'Nara Park Deer Area', lat: 34.6851, lng: 135.8050, city: 'Nara', prefecture: 'Nara', category: 'culture', description: 'Friendly deer roaming freely. Buy deer crackers to feed them.', tags: ['deer', 'park', 'animals'] },
            { id: 'todaiji_temple', name: 'Todai-ji Temple', lat: 34.6889, lng: 135.8398, city: 'Nara', prefecture: 'Nara', category: 'culture', description: 'World\'s largest bronze Buddha statue in historic temple.', tags: ['temple', 'buddha', 'history'] },
            { id: 'nara_mochi', name: 'Nara Traditional Mochi Shop', lat: 34.6851, lng: 135.8050, city: 'Nara', prefecture: 'Nara', category: 'mochi', description: 'Historic mochi shop using techniques from Nara period.', tags: ['mochi', 'traditional', 'history'] },

            // ========== OKINAWA AREA (6+ spots) ==========
            { id: 'okinawa_ramen', name: 'Okinawa Soba Restaurants', lat: 26.2124, lng: 127.6809, city: 'Naha', prefecture: 'Okinawa', category: 'food', description: 'Try Okinawa soba - unique noodle dish different from mainland.', tags: ['soba', 'okinawa', 'local'] },
            { id: 'kokusai_street', name: 'Kokusai Street Food', lat: 26.2154, lng: 127.6831, city: 'Naha', prefecture: 'Okinawa', category: 'food', description: 'Main street with Okinawan food: goya champuru, taco rice.', tags: ['streetfood', 'okinawa', 'local'] },

            // ========== SMALL TOWNS & HIDDEN GEMS (20+ spots) ==========
            { id: 'takayama_food', name: 'Takayama Morning Markets', lat: 36.1408, lng: 137.2529, city: 'Takayama', prefecture: 'Gifu', category: 'food', description: 'Traditional morning markets with local produce and snacks.', tags: ['market', 'morning', 'local'] },
            { id: 'kobe_beef', name: 'Kobe Beef Restaurants', lat: 34.6901, lng: 135.1955, city: 'Kobe', prefecture: 'Hyogo', category: 'food', description: 'Authentic Kobe beef restaurants. Must try in Kobe.', tags: ['beef', 'kobe', 'wagyu'] },
            { id: 'beppu_onsen', name: 'Beppu Hot Spring Hells', lat: 33.2786, lng: 131.5001, city: 'Beppu', prefecture: 'Oita', category: 'onsen', description: 'Eight geothermal hot springs with different colored waters.', tags: ['onsen', 'geothermal', 'hells'] },
            { id: 'matsumoto_castle', name: 'Matsumoto Castle Area', lat: 36.2386, lng: 137.9690, city: 'Matsumoto', prefecture: 'Nagano', category: 'culture', description: 'Black castle with original wooden interior. National treasure.', tags: ['castle', 'black', 'history'] },
            { id: 'shirakawago', name: 'Shirakawa-go Village', lat: 36.2710, lng: 136.8986, city: 'Shirakawa', prefecture: 'Gifu', category: 'culture', description: 'UNESCO world heritage village with traditional thatched houses.', tags: ['village', 'unesco', 'traditional'] },
            { id: 'nikko_temples', name: 'Nikko Temple Complex', lat: 36.7581, lng: 139.5995, city: 'Nikko', prefecture: 'Tochigi', category: 'culture', description: 'UNESCO world heritage site with ornate temples and nature.', tags: ['temple', 'unesco', 'nature'] },
            { id: 'hakone_onsen', name: 'Hakone Hot Springs', lat: 35.2428, lng: 139.1063, city: 'Hakone', prefecture: 'Kanagawa', category: 'onsen', description: 'Onsen resorts with views of Mount Fuji on clear days.', tags: ['onsen', 'mountfuji', 'view'] },
            { id: 'kamakura_matcha', name: 'Kamakura Bamboo Matcha', lat: 35.3190, lng: 139.5505, city: 'Kamakura', prefecture: 'Kanagawa', category: 'matcha', description: 'Matcha houses in historic Kamakura near Great Buddha.', tags: ['matcha', 'kamakura', 'buddha'] },
            { id: 'sendai_food', name: 'Sendai Gyutan Alley', lat: 38.2682, lng: 140.8694, city: 'Sendai', prefecture: 'Miyagi', category: 'food', description: 'Beef tongue specialty restaurants - Sendai\'s famous dish.', tags: ['gyutan', 'beef', 'sendai'] },
            { id: 'aomori_apples', name: 'Aomori Apple Orchards', lat: 40.8221, lng: 140.7474, city: 'Aomori', prefecture: 'Aomori', category: 'food', description: 'Apple picking and apple-based foods in Japan\'s apple capital.', tags: ['apples', 'orchard', 'aomori'] }
        ];

        // ========== APP STATE ==========
        let map;
        let markers = [];
        let filteredPlaces = [...JAPAN_SPOTS];
        let currentCategory = 'all';
        let selectedPlaceId = null;
        let favorites = JSON.parse(localStorage.getItem('japanFavorites')) || [];

        // ========== INITIALIZE APP ==========
        function initApp() {
            initMap();
            renderPlacesList();
            updatePlacesCount();
            setupEventListeners();
            
            // Show initial loading then hide
            setTimeout(() => {
                const placesContainer = document.getElementById('placesContainer');
                if (placesContainer) {
                    placesContainer.innerHTML = '';
                    renderPlacesList();
                }
            }, 500);
        }

        // ========== MAP FUNCTIONS ==========
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([36.2048, 138.2529], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);
            
            // Add markers
            addMarkersToMap();
            
            // Fit bounds to Japan
            const japanBounds = L.latLngBounds(
                [24.3963, 122.9346], // Southwest (Okinawa)
                [45.5232, 145.8209]  // Northeast (Hokkaido)
            );
            map.fitBounds(japanBounds);
        }

        function addMarkersToMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers
            filteredPlaces.forEach(place => {
                const marker = L.marker([place.lat, place.lng], {
                    icon: getMarkerIcon(place.category)
                });
                
                // Create popup
                const popupContent = `
                    <div style="max-width: 250px;">
                        <h4 style="margin: 0 0 8px; color: #1e293b;">${place.name}</h4>
                        <div style="color: #64748b; font-size: 0.9rem; margin-bottom: 8px;">
                            <i class="fas fa-map-marker-alt"></i> ${place.city}, ${place.prefecture}
                        </div>
                        <div style="color: #475569; font-size: 0.85rem; margin-bottom: 12px;">
                            ${place.description}
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button onclick="openDirections(${place.lat}, ${place.lng})" style="flex:1; padding: 6px; background: #e60012; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-directions"></i> Directions
                            </button>
                            <button onclick="sharePlace('${place.id}')" style="flex:1; padding: 6px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-share"></i> Share
                            </button>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                
                marker.on('click', () => {
                    selectPlace(place.id);
                    // Open sidebar when clicking on marker (mobile)
                    if (window.innerWidth < 768) {
                        toggleSidebar(true);
                    }
                });
                
                marker.addTo(map);
                markers.push(marker);
            });
        }

        function getMarkerIcon(category) {
            const colors = {
                pokemon: '#FFCB05',
                food: '#F59E0B',
                matcha: '#10B981',
                mochi: '#8B5CF6',
                teamlab: '#3B82F6',
                onsen: '#06B6D4',
                shopping: '#EC4899',
                culture: '#A855F7'
            };
            
            const color = colors[category] || '#E60012';
            const iconHtml = `
                <div style="
                    background: ${color};
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 10px;
                ">
                    <i class="fas fa-${getCategoryIcon(category)}"></i>
                </div>
            `;
            
            return L.divIcon({
                html: iconHtml,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
        }

        function getCategoryIcon(category) {
            const icons = {
                pokemon: 'gamepad',
                food: 'utensils',
                matcha: 'leaf',
                mochi: 'cookie-bite',
                teamlab: 'palette',
                onsen: 'hot-tub',
                shopping: 'shopping-bag',
                culture: 'landmark'
            };
            return icons[category] || 'map-marker-alt';
        }

        // ========== UI FUNCTIONS ==========
        function renderPlacesList() {
            const container = document.getElementById('placesContainer');
            if (!container) return;
            
            if (filteredPlaces.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 2rem;">No places found. Try another filter.</div>';
                return;
            }
            
            let html = '';
            filteredPlaces.forEach(place => {
                const isActive = selectedPlaceId === place.id;
                const isFavorite = favorites.includes(place.id);
                const categoryClass = `${place.category}-badge`;
                
                html += `
                    <div class="place-card ${isActive ? 'active' : ''}" onclick="selectPlace('${place.id}')">
                        <div class="place-category ${categoryClass}">
                            ${place.category.toUpperCase()}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h3>${place.name}</h3>
                            <button onclick="toggleFavorite('${place.id}'); event.stopPropagation();" 
                                    style="background: transparent; border: none; color: ${isFavorite ? '#ff4757' : 'var(--text-gray)'}; font-size: 1rem; padding: 0.3rem;">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        <div class="place-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${place.city}, ${place.prefecture}
                        </div>
                        <p class="place-description">${place.description}</p>
                        <div class="place-tags">
                            ${place.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div class="place-actions">
                            <button class="action-btn directions-btn" onclick="openDirections(${place.lat}, ${place.lng}); event.stopPropagation();">
                                <i class="fas fa-directions"></i> Directions
                            </button>
                            <button class="action-btn" onclick="sharePlace('${place.id}'); event.stopPropagation();">
                                <i class="fas fa-share"></i> Share
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updatePlacesCount() {
            const placesCount = document.getElementById('placesCount');
            if (placesCount) {
                placesCount.textContent = `${filteredPlaces.length} places`;
            }
        }

        function selectPlace(placeId) {
            selectedPlaceId = placeId;
            const place = JAPAN_SPOTS.find(p => p.id === placeId);
            
            if (place) {
                // Center map on place
                map.setView([place.lat, place.lng], 15);
                
                // Open popup
                markers.forEach(marker => {
                    const latLng = marker.getLatLng();
                    if (latLng.lat === place.lat && latLng.lng === place.lng) {
                        marker.openPopup();
                    }
                });
                
                // Update UI
                renderPlacesList();
                
                // Open sidebar on mobile when selecting place
                if (window.innerWidth < 768) {
                    toggleSidebar(true);
                }
            }
        }

        function filterPlaces() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            filteredPlaces = JAPAN_SPOTS.filter(place => {
                // Category filter
                if (currentCategory !== 'all' && place.category !== currentCategory) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchText = `${place.name} ${place.city} ${place.prefecture} ${place.description} ${place.tags.join(' ')}`.toLowerCase();
                    return searchText.includes(searchTerm);
                }
                
                return true;
            });
            
            addMarkersToMap();
            renderPlacesList();
            updatePlacesCount();
        }

        // ========== SIDEBAR FUNCTIONS ==========
        function toggleSidebar(open) {
            const sidebar = document.getElementById('sidebarPanel');
            const overlay = document.getElementById('overlayBackdrop');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            if (open === undefined) {
                open = !sidebar.classList.contains('open');
            }
            
            if (open) {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                toggleBtn.style.background = '#3b82f6';
            } else {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                toggleBtn.style.background = 'var(--primary-red)';
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function openDirections(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=transit`;
            window.open(url, '_blank');
        }

        function sharePlace(placeId) {
            const place = JAPAN_SPOTS.find(p => p.id === placeId);
            if (!place) return;
            
            const text = `Check out ${place.name} in ${place.city}, Japan! Found via @Muchan_official's Japan Explorer map.`;
            const url = window.location.href.split('#')[0] + `#place=${placeId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: place.name,
                    text: text,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
                    alert('Link copied! Paste in TikTok or Instagram.');
                });
            }
        }

        function toggleFavorite(placeId) {
            const index = favorites.indexOf(placeId);
            if (index === -1) {
                favorites.push(placeId);
            } else {
                favorites.splice(index, 1);
            }
            localStorage.setItem('japanFavorites', JSON.stringify(favorites));
            renderPlacesList();
        }

        function showFavorites() {
            filteredPlaces = JAPAN_SPOTS.filter(place => favorites.includes(place.id));
            if (filteredPlaces.length === 0) {
                alert('No favorites yet! Tap the heart on any place to save it.');
                filteredPlaces = [...JAPAN_SPOTS];
            }
            addMarkersToMap();
            renderPlacesList();
            updatePlacesCount();
            
            // Update active nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('navFavorites').classList.add('active');
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            // Search box
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', filterPlaces);
            }
            
            // Filter chips
            document.querySelectorAll('.filter-chip').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    filterPlaces();
                    
                    // Open sidebar when filtering on mobile
                    if (window.innerWidth < 768) {
                        toggleSidebar(true);
                    }
                });
            });
            
            // Sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                toggleSidebar();
            });
            
            document.getElementById('closePanel').addEventListener('click', () => {
                toggleSidebar(false);
            });
            
            document.getElementById('overlayBackdrop').addEventListener('click', () => {
                toggleSidebar(false);
            });
            
            // Map controls
            document.getElementById('locateMe').addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        map.setView([position.coords.latitude, position.coords.longitude], 13);
                    });
                }
            });
            
            document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());
            document.getElementById('fitMarkers').addEventListener('click', () => {
                if (filteredPlaces.length > 0) {
                    const bounds = L.latLngBounds(filteredPlaces.map(p => [p.lat, p.lng]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    const japanBounds = L.latLngBounds(
                        [24.3963, 122.9346],
                        [45.5232, 145.8209]
                    );
                    map.fitBounds(japanBounds);
                }
            });
            
            // Mobile navigation
            document.getElementById('navMap').addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('navMap').classList.add('active');
                // Close sidebar on mobile
                if (window.innerWidth < 768) {
                    toggleSidebar(false);
                }
            });
            
            document.getElementById('navSearch').addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('navSearch').classList.add('active');
                document.getElementById('mobileSearch').style.display = 'block';
                document.getElementById('searchBox').focus();
            });
            
            document.getElementById('navFavorites').addEventListener('click', showFavorites);
            
            document.getElementById('navShare').addEventListener('click', () => {
                document.getElementById('shareModal').style.display = 'flex';
            });
            
            document.getElementById('navMenu').addEventListener('click', () => {
                document.getElementById('affiliateModal').style.display = 'flex';
            });
            
            // Close search when clicking outside
            document.addEventListener('click', (e) => {
                const mobileSearch = document.getElementById('mobileSearch');
                const navSearch = document.getElementById('navSearch');
                if (mobileSearch && !e.target.closest('#mobileSearch') && !e.target.closest('#navSearch')) {
                    mobileSearch.style.display = 'none';
                }
            });
            
            // Modal close buttons
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('affiliateModal').style.display = 'none';
            });
            
            document.getElementById('closeShareModal').addEventListener('click', () => {
                document.getElementById('shareModal').style.display = 'none';
            });
            
            // Handle deep linking
            if (window.location.hash) {
                const placeId = window.location.hash.replace('#place=', '');
                if (placeId && JAPAN_SPOTS.some(p => p.id === placeId)) {
                    setTimeout(() => {
                        selectPlace(placeId);
                        toggleSidebar(true);
                    }, 1000);
                }
            }
            
            // Handle resize
            window.addEventListener('resize', () => {
                setTimeout(() => map.invalidateSize(), 300);
            });
        }

        // ========== SHARE FUNCTIONS ==========
        function shareTo(platform) {
            const url = window.location.href;
            const text = `Explore Japan with @Muchan_official's interactive map! 150+ food spots, Pokémon Centers, matcha ceremonies, and more.`;
            
            let shareUrl = '';
            switch(platform) {
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
                    break;
                case 'tiktok':
                    // Copy to clipboard for TikTok
                    navigator.clipboard.writeText(`${text}\n${url}`).then(() => {
                        alert('Link copied! Open TikTok and paste in your video description.');
                    });
                    return;
                case 'telegram':
                    shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank');
            }
        }

        // ========== EXPOSE FUNCTIONS ==========
        window.openDirections = openDirections;
        window.sharePlace = sharePlace;
        window.selectPlace = selectPlace;
        window.toggleFavorite = toggleFavorite;
        window.shareTo = shareTo;
        window.toggleSidebar = toggleSidebar;

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>